/**
 * Brick Game - Version 0.5
 * Tile-matching puzzle game.
 * Author: Ivan Kasenkov - kacenkov7@gmail.com
 * Build date: 2014-08-29 17:05:12
 * Copyright (c) 2014
 * Released under the GPL3 license
 */
!function(){function a(a,b,c){for(var d=0,e=a.length;e>d;d++)for(var f=0,g=a[d].length;g>f;f++)b.call(c||this,a[d],d,a[d][f],f)}function b(a){var c=a;if(a&&"object"==typeof a){c="[object Array]"===Object.prototype.toString.call(a)?[]:{};for(var d in a)a.hasOwnProperty(d)&&(c[d]=b(a[d]))}return c}function c(a){for(var b,c,d=a.length;d;b=Math.floor(Math.random()*d),c=a[--d],a[d]=a[b],a[b]=c);return a}function d(a){var b="â€‰";return(+a).formatMoney(0,"",b)}function e(){var a=[];for(var b in R)R.hasOwnProperty(b)&&a.push(new R[b]);return c(a)}function f(){if(null!==V.field){var a=30,b=5,c=2,e=V.fieldY/V.fieldX,f=window.innerWidth-2*a,g=window.innerHeight-2*a,h=g/e;h>f&&(h=f);var i=Math.round((h-2*(b+c))/V.fieldX),j=Math.round(.04*i);h=i*V.fieldX+2*(b+c);var k='<div class="field-box" style="width:'+h+'px;">';V.field.each(function(a){k+='<div class="row">',a.each(function(a){k+='<div style="border-width:'+j+"px;width:"+i+"px;height:"+i+'px;" class="brick ',k+=1===a[0]?U[a[1]]:"empty",1===a[2]&&(k+=" active"),1===a[3]&&(k+=" blink"),1===a[4]&&(k+=" next"),k+='"></div>'}),k+="</div>"}),k+="</div>";var l="";l+=V.turnOnAI?'<div class="item ai-title">AI</div>':"",l+=V.score>0?'<div class="item score">'+d(V.score)+"</div>":"",T.innerHTML=l,S.innerHTML=k}}function g(){for(var a=[],b=0;b<V.fieldX;b++)a.push([0,0,0,0,0]);return a}function h(){clearTimeout(V.timeout),V.isPause=!0}function i(){V.isPause=!1,n()}function j(){return V.isPause===!0}function k(){V.turnOnAI=!0,V.isPause=!1,V.startTime=new Date,V.speedCurrent=V.speedStart,V.score=0,V.field=W(),V.currentFigure=null,V.bagFigures=[],V.nextFigure=l(),m()}function l(){return 0===V.bagFigures.length&&(V.bagFigures=e()),V.bagFigures.pop()}function m(){clearTimeout(V.timeout),V.currentFigure=null,V.field=p(V.field);var a=function(){var a=V.nextFigure,b=o(V.field,a);return b===!1?(C(),!1):(V.field=b,V.currentFigure=a,V.nextFigure=l(),q(),f(),n(),void(V.turnOnAI&&G()))};z()?V.timeout=setTimeout(a,V.turnOnAI?50:900):a()}function n(){var a=function(){u()===!0?n():m()};clearTimeout(V.timeout),V.timeout=setTimeout(a,V.turnOnAI?100:V.speedCurrent)}function o(b,c){var d=!0,e=b.clone();return a(c.states[c.currentState],function(a,b,f,g){if(1===f){var h=b+c.gridY,i=g+c.gridX;return"undefined"==typeof e[h]||"undefined"==typeof e[h][i]?(d=!1,!1):0!==e[h][i][0]?(d=!1,!1):(e[h][i][0]=1,e[h][i][1]=c.color,e[h][i][2]=1,e[h][i][3]=0,void 0)}}),d?e:!1}function p(b){var c=b.clone();return a(c,function(a,b,c){c[2]=0}),c}function q(){var b=V.field,c=V.nextFigure;a(b,function(a,b,c){c[4]=0}),a(c.states[c.currentState],function(a,d,e,f){if(1===e){var g=d+c.gridY,h=f+c.gridX;"undefined"!=typeof b[g]&&"undefined"!=typeof b[g][h]&&(b[g][h][4]=1)}})}function r(b,c){var d=b.clone();return null!==c&&a(c.states[c.currentState],function(a,b,e,f){if(1===e){var g=b+c.gridY,h=f+c.gridX;"undefined"!=typeof d[g]&&"undefined"!=typeof d[g][h]&&(d[g][h][0]=0,d[g][h][1]=0,d[g][h][2]=0,d[g][h][3]=0)}}),d}function s(a,b){if(j()||null===b)return!1;var c=o(a,b);return c?{field:c,figure:b.clone()}:!1}function t(a){return a===!1?!1:(V.field=a.field,V.currentFigure=a.figure,f(),!0)}function u(){if(null!==V.currentFigure){var a=V.currentFigure.clone(),b=r(V.field,a);return a.gridY++,t(s(b,a))}}function v(){if(null!==V.currentFigure){var a=V.currentFigure.clone(),b=r(V.field,a);return a.gridX--,t(s(b,a))}}function w(){if(null!==V.currentFigure){var a=V.currentFigure.clone(),b=r(V.field,a);return a.gridX++,t(s(b,a))}}function x(){if(null!==V.currentFigure){var a=V.currentFigure.clone(),b=r(V.field,a);return++a.currentState>a.states.length-1&&(a.currentState=0),t(s(b,a))}}function y(){clearTimeout(V.timeout),u()===!0?V.timeout=setTimeout(y,7):n()}function z(){var a=[];return V.field.each(function(b,c){var d=!0;b.each(function(a){1!==a[0]&&(d=!1)}),d&&a.push(c)}),a.length>0?(a.each(function(a){V.field[a].each(function(a){a[3]=1})}),f(),a.each(function(b){V.field.splice(b,1),V.field.unshift(g()),V.speedCurrent-=V.speedCurrent*V.speedStep/100,V.speedCurrent<100&&(V.speedCurrent=300),V.score+=V.fieldX*a.length}),!0):!1}function A(){var a=Math.round((new Date-V.startTime)/1e3),b=Math.floor(a/3600),c=Math.floor((a-3600*b)/60),d=Math.floor(a-60*c),e="";return e=b>0?B(b)+":"+B(c)+":"+B(d):c>0?B(c)+":"+B(d):d+" sec."}function B(a){return a>9?a:"0"+a}function C(){var a=Math.round((new Date-V.startTime)/1e3),b=Math.floor(a/60),c=(Math.round(a-60*b),'<div class="popup">');c+='<div class="title">Good game!</div>',c+='<table><tr><td>Your score</td><td class="score">'+d(V.score)+"</td></tr>",c+="<tr><td>Time</td><td>"+A()+"</td></tr></table>",c+='<div class="button-box"><div class="button">Start new game</div></div>',c+="</div>";var e=document.getElementById("popup");e.innerHTML=c,h();var f;f=function(a){a.stopPropagation(),i(),k(),e.removeEventListener("click",f,!1),e.innerHTML=""},e.addEventListener("click",f,!1)}function D(){h();var a=(new Date-V.startTime,'<div class="popup">');a+='<div class="title">Paused</div>',a+='<div class="button-box"><div class="button">Resume game</div></div>',a+="</div>";var b=document.getElementById("popup");b.innerHTML=a,h();var c;c=function(a){a.stopPropagation(),i(),b.removeEventListener("click",c,!1),b.innerHTML=""},b.addEventListener("click",c,!1)}function E(a,b,c,d,e,f){return c>f?a>e?1:e>b?3:2:f>d?a>e?7:e>b?9:8:a>e?4:e>b?6:5}function F(){for(var a={bottom:[],left:[],right:[],top:[]},b=document.body.querySelectorAll(".active"),c=null,d=0;d<b.length;d++)c=b[d].getBoundingClientRect(),a.bottom.push(c.bottom),a.left.push(c.left),a.right.push(c.right),a.top.push(c.top);var e=function(a,b){return b>a?-1:a>b?1:0};a.bottom.sort(e).reverse(),a.left.sort(e),a.right.sort(e).reverse(),a.top.sort(e);var f={bottom:a.bottom[0],left:a.left[0],right:a.right[0],top:a.top[0]};return f}function G(){if(null===V.currentFigure||j())return!1;clearTimeout(V.timeout);var a=r(V.field,V.currentFigure),b=H(a,V.currentFigure),c=K(b,a,V.nextFigure),d=L(c);d!==!1&&N(d.pos_x,d.state)}function H(a,b){var c=a.clone(),d=b.clone(),e=[];d.gridY<0&&(d.gridY=0);for(var f=d.gridX,g=0;g<d.states.length;g++){for(++d.currentState>d.states.length-1&&(d.currentState=0),d.gridX=f;;){d.gridX--;var h=d.clone();if(h.gridY=I(c,d),null===h.gridY)break;e.push({figure:h,rating:M(c,h)})}for(d.gridX=f-1;;){d.gridX++;var i=d.clone();if(i.gridY=I(c,d),null===i.gridY)break;e.push({figure:i,rating:M(c,i)})}}return e}function I(a,b){for(var c=b.clone(),d=null;o(a,c)!==!1;)d=c.gridY++;return d}function J(a){var b=function(a,b){return a.rating<b.rating?-1:a.rating>b.rating?1:0};return a.sort(b)}function K(a,b,c){var d=2,e=J(a).slice(-d),f=[];return e.each(function(a){var d=o(b,a.figure);d.each(function(a,b){var c=!0;a.each(function(a){1!==a[0]&&(c=!1)}),c&&(d.splice(b,1),d.unshift(g()))});var e=L(H(d,c));e!==!1&&"undefined"!=typeof e.rating&&(a.rating+=e.rating,f.push(a))}),f}function L(a){var b=J(a).pop();return"undefined"==typeof b||"undefined"==typeof b.figure?!1:{pos_x:b.figure.gridX,state:b.figure.currentState,rating:b.rating}}function M(a,b){for(var c,d,e=o(a,b),f=0,g=0,h=0,i=0,j=0,k=null;j<V.fieldX;j++){c=!0,d=V.fieldY;for(var l=0;l<V.fieldY;l++)1!==e[l][j][0]?c?d--:g++:c=!1;f+=d,null!==k&&(i+=Math.abs(k-d)),k=d}return e.each(function(a){var b=!0;a.each(function(a){1!==a[0]&&(b=!1)}),b&&h++}),.99275*h+-.66569*f+-.46544*g+-.24077*i}function N(a,b){O(!0),Q(!0,b),P(!0,a),y()}function O(a){V.currentFigure.gridY<0&&a&&(a=u(),O(a))}function P(a,b){V.currentFigure.gridX!==b&&a&&(V.currentFigure.gridX>b?a=v():V.currentFigure.gridX<b&&(a=w()),P(a,b))}function Q(a,b){V.currentFigure.currentState!==b&&a&&(a=x(),Q(a,b))}Array.prototype.each=function(a,b){for(var c=0,d=this.length;d>c;c++)a.call(b||this,this[c],c)},Object.prototype.clone=function(){return b(this)},Array.prototype.clone=function(){return b(this)},Number.prototype.formatMoney=function(a,b,c){var d=this,e=isNaN(a=Math.abs(a))?2:a,f=void 0===b?".":b,g=void 0===c?",":c,h=0>d?"-":"",i=parseInt(d=Math.abs(+d||0).toFixed(e))+"",j=(j=i.length)>3?j%3:0;return h+(j?i.substr(0,j)+g:"")+i.substr(j).replace(/(\d{3})(?=\d)/g,"$1"+g)+(e?f+Math.abs(d-i).toFixed(e).slice(2):"")};var R={I:function(){this.states=[[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],[[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]],[[0,0,0,0],[0,0,0,0],[1,1,1,1],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]]],this.color=4,this.gridX=3,this.gridY=-1,this.currentState=0},J:function(){this.states=[[[1,0,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,1,0],[0,1,0,0],[0,1,0,0],[0,0,0,0]],[[0,0,0,0],[1,1,1,0],[0,0,1,0],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[1,1,0,0],[0,0,0,0]]],this.color=5,this.gridX=4,this.gridY=-1,this.currentState=2},L:function(){this.states=[[[0,0,1,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[0,1,1,0],[0,0,0,0]],[[0,0,0,0],[1,1,1,0],[1,0,0,0],[0,0,0,0]],[[1,1,0,0],[0,1,0,0],[0,1,0,0],[0,0,0,0]]],this.color=1,this.gridX=4,this.gridY=-1,this.currentState=2},O:function(){this.states=[[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]]],this.color=2,this.gridX=3,this.gridY=0,this.currentState=0},S:function(){this.states=[[[0,1,1,0],[1,1,0,0],[0,0,0,0],[0,0,0,0]],[[0,1,0,0],[0,1,1,0],[0,0,1,0],[0,0,0,0]],[[0,0,0,0],[0,1,1,0],[1,1,0,0],[0,0,0,0]],[[1,0,0,0],[1,1,0,0],[0,1,0,0],[0,0,0,0]]],this.color=3,this.gridX=4,this.gridY=0,this.currentState=0},T:function(){this.states=[[[0,1,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,0,0],[0,1,1,0],[0,1,0,0],[0,0,0,0]],[[0,0,0,0],[1,1,1,0],[0,1,0,0],[0,0,0,0]],[[0,1,0,0],[1,1,0,0],[0,1,0,0],[0,0,0,0]]],this.color=6,this.gridX=4,this.gridY=-1,this.currentState=2},Z:function(){this.states=[[[1,1,0,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,0,1,0],[0,1,1,0],[0,1,0,0],[0,0,0,0]],[[0,0,0,0],[1,1,0,0],[0,1,1,0],[0,0,0,0]],[[0,1,0,0],[1,1,0,0],[1,0,0,0],[0,0,0,0]]],this.color=0,this.gridX=4,this.gridY=0,this.currentState=0}},S=document.getElementById("window"),T=document.getElementById("status"),U=["red","orange","yellow","green","cyan","blue","violet"];window.addEventListener("resize",f);var V={};V.fieldX=10,V.fieldY=22,V.speedStart=1e3,V.speedStep=1,V.speedCurrent=null,V.currentFigure=null,V.nextFigure=null,V.bagFigures=[],V.timeout=null,V.field=null,V.score=null,V.startTime=null,V.isPause=!0,V.turnOnAI=!1;var W=function(){for(var a=[],b=0;b<V.fieldY;b++)a[b]=g();return a},X=document.getElementById("intro");X.addEventListener("click",function(a){a.stopPropagation(),X.parentNode.removeChild(X),setTimeout(k,0)}),window.addEventListener("keydown",function(a){j()||(38===a.keyCode?x():39===a.keyCode?w():37===a.keyCode&&v())}),window.addEventListener("keyup",function(a){j()||(72===a.keyCode&&(V.turnOnAI?V.turnOnAI=!1:(V.turnOnAI=!0,G())),40===a.keyCode?y():27===a.keyCode&&(j()||D()))}),window.addEventListener("mousedown",function(a){if(!j()){var b=F(),c=E(b.left,b.right,b.top,b.bottom,a.clientX,a.clientY);1===c||4===c||7===c?v():3===c||6===c||9===c?w():2===c||5===c?x():8===c&&y()}})}();
